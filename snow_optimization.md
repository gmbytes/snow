# Snow 优化方案与落地路线图

> 本文基于 聚焦 Snow 的可演进优化方案。目标是在保持 Snow「轻量、开箱即用」优势的同时，补齐治理能力与规模化短板。

## 1. 优化目标

- **稳定性目标**：降低异常中断和停机风险，提升可恢复能力。
- **性能目标**：减少高频路径的 GC 与反射开销，提升吞吐与延迟稳定性。
- **可观测性目标**：具备指标、日志、追踪三位一体的排障能力。
- **架构目标**：降低 `routines/node` 与 `core/host` 的耦合，提升模块可替换性。

## 2. 优先级总览

| 优先级 | 主题 | 产出 |
|--------|------|------|
| **P0** | 可靠性与治理基线 | context 传播、错误模型、优雅停机、基础指标 |
| **P1** | 性能与运行效率 | 序列化可插拔、对象池化、反射热点优化、日志背压 |
| **P2** | 架构演进 | Node 分层解耦、服务发现、测试与文档工具化 |

## 3. P0：可靠性与治理基线（优先立即推进）

### 3.1 RPC 全链路 `context.Context` 传播

**现状**
- `IRpcContext` 缺少标准 Context 访问，超时/取消/追踪难统一。

**改进建议**
- 在 `IRpcContext` 增加 `Context() context.Context`。
- Proxy.Call 支持传入父 Context，默认继承调用方上下文。
- 超时统一从 Context 派生，避免多套 timeout 机制并存。

**验收标准**
- 任一 RPC 可由上游取消并快速退出。
- 超时由 Context 控制后，日志/指标可关联同一 trace。

### 3.2 统一错误模型（错误码 + 包装）

**现状**
- 部分路径依赖 panic/recover，错误语义不稳定。

**改进建议**
- 定义统一错误码（例如：`ErrTimeout`、`ErrServiceNotFound`、`ErrCodec`、`ErrTransport`）。
- 约定 RPC 返回中错误优先通过 `error` 显式表达，`ctx.Error()` 作为兼容层。
- 对外暴露 `Is/As` 友好的错误包装结构。

**验收标准**
- 线上告警可按错误码聚合统计。
- 主要异常路径不依赖 panic 才能返回错误。

### 3.3 优雅停机（Drain 模式）

**现状**
- 停机主要依赖固定超时，缺少“停止接入新请求”阶段。

**改进建议**
- 引入三阶段停机：`拒绝新请求 -> 等待进行中请求 -> 强制超时退出`。
- 对 Service 增加可选的 `BeforeStop/AfterStop` 钩子。
- 停机顺序支持依赖拓扑（被依赖者后停）。

**验收标准**
- 停机期间请求错误率显著下降，未完成请求有明确统计。
- 超时强制退出前可输出剩余会话明细。

### 3.4 基础可观测性落地

**现状**
- 有 `IMetricCollector` 接口，但缺少官方默认实现和统一指标规范。

**改进建议**
- 提供内置 Prometheus 实现（可替换）。
- 建立最小指标集：QPS、P95/P99、错误率、会话数、重连次数、队列长度。
- 统一日志字段：trace_id、service、method、peer、error_code。

**验收标准**
- 默认部署即可拉取关键指标并定位慢调用。

## 4. P1：性能与运行效率

### 4.1 编解码可插拔（ICodec）

**现状**
- RPC 主要依赖 JSON（`xjson`），高频场景开销明显。

**改进建议**
- 定义统一编解码接口：

```go
type ICodec interface {
    Marshal(v any) ([]byte, error)
    Unmarshal(data []byte, v any) error
    Name() string
}
```

- 默认保留 JSON，新增 MessagePack/Protobuf 插件实现。
- 协议层增加 codec 标识，支持灰度切换。

**验收标准**
- 在基准压测中，二进制 codec 相比 JSON 的 CPU 或延迟有可量化下降。

### 4.2 高频对象池化

**对象范围**
- `message`、`rpcContext`、`promise`、临时 `[]byte` buffer。

**改进建议**
- 使用 `sync.Pool` 管理生命周期；复用前清理状态，避免脏数据污染。
- 提供调试开关，便于排查池化相关问题。

**验收标准**
- GC 次数与内存分配速率显著下降，延迟抖动收敛。

### 4.3 反射热点优化

**现状**
- RPC 分发存在 `reflect.Value.Call` 高频开销。

**改进建议**
- 启动阶段构建 method dispatch 缓存（参数类型、调用桥）。
- 对热点方法提供类型安全包装（代码生成或泛型桥接）。

**验收标准**
- 热点 RPC 的平均耗时与 CPU 占比下降。

### 4.4 日志写入背压与缓冲治理

**现状**
- 文件日志 channel 固定容量，流量尖峰存在堆积或丢失风险。

**改进建议**
- 缓冲容量配置化。
- 引入背压策略（阻塞、丢弃低级别、采样）与告警计数器。

**验收标准**
- 高峰期日志行为可预测，可观测，不出现无感丢失。

## 5. P2：架构演进与工程化

### 5.1 Node 分层解耦

**目标**
- 让 `node` 的传输、路由、编解码、会话管理可替换，减少对 Host 强绑定。

**建议分层**
- `node/api`：业务可见接口（Service/Proxy/Context）
- `node/runtime`：调度与生命周期
- `node/transport`：tcp/http/memory
- `node/codec`：编解码
- `node/discovery`：可选服务发现

### 5.2 服务发现与动态路由（可选）

**建议**
- 增加静态表 + 注册中心双模式。
- 支持健康检查、剔除与自动恢复。

### 5.3 测试与文档工具化

**建议**
- 提供 Mock `IProxy`、`IRpcContext`。
- 提供测试节点启动器（单进程多节点/内存传输）。
- 提供 RPC 文档生成工具（含 HTTP RPC 的 OpenAPI 输出）。

## 6. 12 周实施路线图（建议）

| 周期 | 目标 | 关键交付 |
|------|------|----------|
| 第 1-2 周 | P0 设计冻结 | Context 方案、错误码规范、停机流程设计评审 |
| 第 3-5 周 | P0 开发联调 | Context 接入、错误模型落地、Drain 停机、基础指标 |
| 第 6 周 | P0 验收 | 压测与故障演练、回归修复 |
| 第 7-9 周 | P1 开发 | ICodec、对象池化、反射缓存、日志背压 |
| 第 10 周 | P1 验收 | 基准测试对比报告 |
| 第 11-12 周 | P2 启动 | Node 分层设计稿、PoC 与迁移方案 |

## 7. 风险与回滚策略

- **协议兼容风险**：编解码切换需支持双栈解码和灰度开关。
- **池化引入脏数据风险**：统一 reset 规范 + race 测试。
- **停机流程改造风险**：保留旧停机逻辑开关，支持一键回退。
- **链路追踪开销风险**：采样率可配，默认低采样上线。

## 8. 成功判定（可量化）

- P0 完成后：故障恢复时间下降，停机错误率下降，关键指标齐备。
- P1 完成后：基准吞吐提升、P99 降低、GC 压力下降。
- P2 启动后：核心模块边界明确，新增传输/编解码成本下降。

---

*建议将本文作为 Snow 的迭代基线文档，按版本持续补充“已完成项”和“指标实测结果”。*
